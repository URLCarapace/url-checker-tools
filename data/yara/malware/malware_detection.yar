/*
 * Malware and Exploit Detection Rules
 * Author: URL Checker Security Team
 * Updated: 2025-01-21
 */

rule Malicious_JavaScript
{
    meta:
        description = "Detects potentially malicious JavaScript patterns"
        author = "Security Team"
        severity = "high"
        category = "malware"

    strings:
        // Obfuscation patterns
        $obfusc1 = /eval\s*\(\s*unescape\s*\(/i
        $obfusc2 = /eval\s*\(\s*atob\s*\(/i
        $obfusc3 = /eval\s*\(\s*String\.fromCharCode/i
        $obfusc4 = /document\.write\s*\(\s*unescape\s*\(/i

        // Dynamic code execution
        $dynamic1 = /new\s+Function\s*\(/i
        $dynamic2 = /setTimeout\s*\(\s*["'][^"']*eval/i
        $dynamic3 = /setInterval\s*\(\s*["'][^"']*eval/i

        // Suspicious API calls
        $api1 = /XMLHttpRequest.*POST.*\/[a-z0-9]{16,}/i
        $api2 = /fetch\s*\(\s*["'][^"']*\/[a-z0-9]{16,}/i

        // Browser exploitation
        $exploit1 = /document\.createElement\s*\(\s*["']iframe["']\)/i
        $exploit2 = /window\.open\s*\(\s*["'][^"']*data:/i
        $exploit3 = /location\.href\s*=\s*["']javascript:/i

    condition:
        2 of them
}

rule Suspicious_Redirects
{
    meta:
        description = "Detects suspicious redirect patterns"
        author = "Security Team"
        severity = "medium"
        category = "malware"

    strings:
        // Meta refresh redirects
        $meta1 = /<meta[^>]*http-equiv\s*=\s*["']refresh["'][^>]*url\s*=/i
        $meta2 = /<meta[^>]*content\s*=\s*["'][0-9]+\s*;\s*url\s*=/i

        // JavaScript redirects
        $js1 = /window\.location\.href\s*=\s*["'][^"']*\.(tk|ml|ga|cf|xyz)/i
        $js2 = /location\.replace\s*\(\s*["'][^"']*\.(tk|ml|ga|cf|xyz)/i
        $js3 = /top\.location\s*=\s*["'][^"']*\.(tk|ml|ga|cf|xyz)/i

        // Form redirects to suspicious domains
        $form1 = /<form[^>]*action\s*=\s*["'][^"']*\.(tk|ml|ga|cf|xyz)/i
        $form2 = /<form[^>]*action\s*=\s*["'][^"']*\/[a-z0-9]{16,}/i

    condition:
        any of them
}

rule Cryptocurrency_Mining
{
    meta:
        description = "Detects cryptocurrency mining scripts"
        author = "Security Team"
        severity = "high"
        category = "malware"

    strings:
        // Known mining libraries
        $coinhive = /coinhive/i
        $cryptoloot = /crypto-loot/i
        $jsecoin = /jsecoin/i
        $minero = /minero/i
        $webminerpool = /webminerpool/i

        // Mining APIs
        $mining1 = /new\s+CoinHive\.Anonymous/i
        $mining2 = /new\s+CoinHive\.User/i
        $mining3 = /cryptoloot\.anonymous/i
        $mining4 = /miner\.start\s*\(\s*\)/i

        // WebAssembly mining
        $wasm1 = /WebAssembly\.instantiate.*mining/i
        $wasm2 = /\.wasm.*hash/i

    condition:
        any of them
}

rule Exploit_Kit_Patterns
{
    meta:
        description = "Detects exploit kit patterns"
        author = "Security Team"
        severity = "critical"
        category = "malware"

    strings:
        // Known exploit kit signatures
        $angler = /angler.*exploit/i
        $blackhole = /blackhole.*exploit/i
        $rig = /rig.*exploit/i
        $magnitude = /magnitude.*exploit/i

        // Flash exploits
        $flash1 = /flash.*cve-[0-9]{4}-[0-9]{4,}/i
        $flash2 = /swf.*exploit/i

        // Java exploits
        $java1 = /java.*cve-[0-9]{4}-[0-9]{4,}/i
        $java2 = /applet.*exploit/i

        // PDF exploits
        $pdf1 = /pdf.*cve-[0-9]{4}-[0-9]{4,}/i
        $pdf2 = /\/JavaScript.*shellcode/i

    condition:
        any of them
}
